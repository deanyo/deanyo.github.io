<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Commute</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDY0IDY0Ij48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iNTIiPvCfjLbvuI88L3RleHQ+PC9zdmc+">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      background: #282a36;
      color: #f8f8f2;
      margin: 0;
      padding: 16px;
      min-height: 100vh;
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { 
      color: #8be9fd;
      font-size: 14px;
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #44475a;
      cursor: pointer;
    }
    h1 span { color: #6272a4; }
    .editing h1 { margin-bottom: 6px; }
    .route-editor {
      display: flex;
      align-items: center;
      gap: 6px;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      margin: 0;
      transition: max-height 0.2s ease, opacity 0.2s ease, margin 0.2s ease;
    }
    .editing .route-editor {
      max-height: 40px;
      opacity: 1;
      margin: 0 0 16px 0;
    }
    .route-input {
      width: 60px;
      background: #1b1c24;
      border: 1px solid #44475a;
      color: #f8f8f2;
      font-family: inherit;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .route-input::placeholder { color: #6272a4; }
    .route-input.error { border-color: #ff5555; color: #ff5555; }
    .route-sep { color: #6272a4; font-size: 12px; }
    .route-note { color: #6272a4; font-size: 10px; margin-left: 6px; }
    .section {
      margin-bottom: 24px;
      background: #21222c;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid #44475a;
    }
    .route {
      color: #bd93f9;
      font-size: 13px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .route .arrow { color: #6272a4; }
    .refresh {
      background: none;
      border: 1px solid #44475a;
      color: #8be9fd;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
    }
    .refresh:active { background: #44475a; }
    .train {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid #44475a;
      font-size: 14px;
      align-items: center;
    }
    .train:last-child { border-bottom: none; }
    .time { color: #50fa7b; width: 50px; }
    .plat { color: #6272a4; width: 35px; }
    .fast { 
      color: #ffb86c;
      font-size: 10px;
      background: #ffb86c20;
      padding: 2px 5px;
      border-radius: 3px;
    }
    .stops { color: #6272a4; font-size: 11px; flex: 1; }
    .status { color: #f8f8f2; text-align: right; min-width: 60px; }
    .delayed .time { color: #ff5555; text-decoration: line-through; }
    .delayed .status { color: #ff5555; }
    .cancelled .time { color: #6272a4; text-decoration: line-through; }
    .cancelled .status { color: #ff5555; }
    .updated {
      color: #6272a4;
      font-size: 11px;
      text-align: center;
      margin-top: 16px;
    }
    .alerts {
      background: #ff555520;
      border: 1px solid #ff555540;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 16px;
      font-size: 12px;
      color: #ff5555;
    }
    .alerts a { color: #8be9fd; }
    .alerts summary {
      cursor: pointer;
      list-style: none;
      outline: none;
    }
    .alerts summary::-webkit-details-marker { display: none; }
    .alerts-body { margin-top: 8px; line-height: 1.4; }
    .loading { color: #6272a4; font-style: italic; }
    .cursor { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="route-header"><span>~/</span><span id="path-label">commute</span><span class="cursor">_</span></h1>
    <form class="route-editor" id="route-editor" autocomplete="off">
      <input class="route-input" id="route-from" placeholder="FROM" maxlength="3" aria-label="From station">
      <span class="route-sep">/</span>
      <input class="route-input" id="route-to" placeholder="TO" maxlength="3" aria-label="To station">
      <span class="route-note">enter to apply</span>
    </form>
    <div class="section">
      <div class="route">
        <span id="outbound-label">WAL <span class="arrow">→</span> WAT</span>
        <button class="refresh" onclick="fetchTrains()">refresh</button>
      </div>
      <div id="outbound"><span class="loading">loading...</span></div>
    </div>
    <div class="section">
      <div class="route">
        <span id="inbound-label">WAT <span class="arrow">→</span> WAL</span>
        <button class="refresh" onclick="fetchTrains()">refresh</button>
      </div>
      <div id="inbound"><span class="loading">loading...</span></div>
    </div>
    <div id="alerts"></div>
    <div class="updated" id="updated"></div>
  </div>
  <script>
    const TOKEN = '89a974d2-2b24-44fb-b22a-f9dd3585190f';
    const DEFAULT_FROM = 'WAL';
    const DEFAULT_TO = 'WAT';

    function isValidCode(code) {
      return /^[A-Z]{3}$/.test(code);
    }

    function buildRoute(from, to) {
      return { from, to, path: `commute/${from.toLowerCase()}/${to.toLowerCase()}` };
    }

    function getRouteFromPath() {
      const parts = window.location.pathname.replace(/\/+$/, '').split('/').filter(Boolean);
      let from = DEFAULT_FROM;
      let to = DEFAULT_TO;
      if (parts.length >= 2) {
        const candidateFrom = parts[0].toUpperCase();
        const candidateTo = parts[1].toUpperCase();
        if (isValidCode(candidateFrom) && isValidCode(candidateTo)) {
          from = candidateFrom;
          to = candidateTo;
        }
      }
      return buildRoute(from, to);
    }

    const stationNames = {};
    let route = getRouteFromPath();
    const container = document.querySelector('.container');
    const header = document.getElementById('route-header');
    const editor = document.getElementById('route-editor');
    const fromInput = document.getElementById('route-from');
    const toInput = document.getElementById('route-to');

    function getStationLabel(code) {
      return stationNames[code] || code;
    }

    function updateRouteUI() {
      document.getElementById('path-label').textContent = route.path;
      document.getElementById('outbound-label').textContent = `${getStationLabel(route.from)} → ${getStationLabel(route.to)}`;
      document.getElementById('inbound-label').textContent = `${getStationLabel(route.to)} → ${getStationLabel(route.from)}`;
      document.title = `My Commute: ${route.from}-${route.to}`;
      if (!container.classList.contains('editing')) {
        fromInput.value = route.from;
        toInput.value = route.to;
      }
    }

    function setRoute(from, to, updateUrl) {
      route = buildRoute(from, to);
      updateRouteUI();
      if (updateUrl) {
        const newPath = `/${from.toLowerCase()}/${to.toLowerCase()}`;
        if (window.location.pathname !== newPath) {
          history.pushState({}, '', newPath);
        }
      }
    }

    function normalizeInput(input) {
      input.value = input.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3);
    }

    function markInvalid(...inputs) {
      inputs.forEach(input => input.classList.add('error'));
      setTimeout(() => inputs.forEach(input => input.classList.remove('error')), 900);
    }

    updateRouteUI();

    header.addEventListener('click', () => {
      container.classList.toggle('editing');
      if (container.classList.contains('editing')) {
        fromInput.focus();
        fromInput.select();
      }
    });

    document.addEventListener('click', (event) => {
      if (!container.classList.contains('editing')) return;
      if (header.contains(event.target) || editor.contains(event.target)) return;
      container.classList.remove('editing');
    });

    function applyRoute() {
      normalizeInput(fromInput);
      normalizeInput(toInput);
      const from = fromInput.value;
      const to = toInput.value;
      if (!isValidCode(from) || !isValidCode(to)) {
        markInvalid(fromInput, toInput);
        return;
      }
      setRoute(from, to, true);
      container.classList.remove('editing');
      fetchTrains();
    }

    editor.addEventListener('submit', (event) => {
      event.preventDefault();
      applyRoute();
    });

    function handleEnter(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        applyRoute();
      }
    }

    fromInput.addEventListener('input', () => normalizeInput(fromInput));
    toInput.addEventListener('input', () => normalizeInput(toInput));
    fromInput.addEventListener('keydown', handleEnter);
    toInput.addEventListener('keydown', handleEnter);

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && container.classList.contains('editing')) {
        container.classList.remove('editing');
      }
    });

    window.addEventListener('popstate', () => {
      route = getRouteFromPath();
      updateRouteUI();
      fetchTrains();
    });

    function renderTrains(trains, dest) {
      if (!trains?.length) return '<span class="loading">no trains</span>';
      const list = trains.slice(0, 5);
      const stopCounts = list.map(t => {
        const allStops = t.subsequentCallingPoints?.[0]?.callingPoint || [];
        if (!allStops.length) return null;
        const destIdx = allStops.findIndex(s => s.crs === dest);
        return destIdx >= 0 ? destIdx + 1 : allStops.length;
      });
      const definedStops = stopCounts.filter(s => s !== null);
      const uniqueStops = [...new Set(definedStops)].sort((a, b) => a - b);
      const fastStopMax = uniqueStops.length >= 3 ? uniqueStops[1] : (uniqueStops[0] ?? null);
      const showFast = uniqueStops.length >= 2;
      return list.map((t, i) => {
        const delayed = t.etd !== 'On time' && t.etd !== t.std && t.etd !== 'Cancelled';
        const cancelled = t.etd === 'Cancelled';
        const cls = cancelled ? 'cancelled' : (delayed ? 'delayed' : '');
        const plat = t.platform ? `P${t.platform}` : '--';
        const stops = stopCounts[i];
        const isFast = showFast && stops !== null && fastStopMax !== null && stops <= fastStopMax;
        const isDirect = stops === 1;
        const stopsLabel = stops === null ? '--' : `${stops} stops`;
        const fastLabel = `${stopsLabel} <span class="fast">FAST</span>`;
        return `<div class="train ${cls}">
          <span class="time">${t.std}</span>
          <span class="plat">${plat}</span>
          <span class="stops">${isDirect ? '<span class="fast">DIRECT</span>' : (isFast ? fastLabel : stopsLabel)}</span>
          <span class="status">${t.etd}</span>
        </div>`;
      }).join('');
    }

    function updateStationNames(from, to, data) {
      if (data?.locationName) {
        stationNames[from] = data.locationName;
      }
      if (data?.filterLocationName) {
        stationNames[to] = data.filterLocationName;
      }
      if (stationNames[from] || stationNames[to]) {
        updateRouteUI();
      }
    }

    function errorMessageFor(from, to) {
      if (stationNames[from] && stationNames[to]) {
        return 'error: unable to load';
      }
      return 'error: are you sure that CRS is valid?';
    }

    function renderError(message) {
      return `<span class="loading">${message}</span>`;
    }

    async function fetchRoute(from, to, elId) {
      try {
        const res = await fetch(`https://huxley2.azurewebsites.net/departures/${from}/to/${to}?accessToken=${TOKEN}&expand=true`);
        const bodyText = await res.text();
        let data = null;
        try {
          data = bodyText ? JSON.parse(bodyText) : null;
        } catch (e) {
          document.getElementById(elId).innerHTML = renderError(errorMessageFor(from, to));
          return [];
        }
        if (!res.ok || !data?.trainServices) {
          document.getElementById(elId).innerHTML = renderError(errorMessageFor(from, to));
          return data?.nrccMessages || [];
        }
        document.getElementById(elId).innerHTML = renderTrains(data.trainServices, to);
        updateStationNames(from, to, data);
        return data.nrccMessages || [];
      } catch (e) {
        document.getElementById(elId).innerHTML = renderError(errorMessageFor(from, to));
        return [];
      }
    }

    async function fetchTrains() {
      const [msgs1, msgs2] = await Promise.all([
        fetchRoute(route.from, route.to, 'outbound'),
        fetchRoute(route.to, route.from, 'inbound')
      ]);
      const allMsgs = [...msgs1, ...msgs2].map(m => m.value);
      const unique = [...new Set(allMsgs)];
      document.getElementById('alerts').innerHTML = unique.length
        ? `<details class="alerts">
            <summary>Service alerts (${unique.length})</summary>
            <div class="alerts-body">${unique.join('<br><br>')}</div>
          </details>`
        : '';
      document.getElementById('updated').textContent = new Date().toLocaleTimeString();
    }

    fetchTrains();
    setInterval(fetchTrains, 60000);
  </script>
</body>
</html>
